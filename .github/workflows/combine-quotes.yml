name: Combine Quotes

on:
  push:
    paths:
      - 'assets/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  combine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Combine and convert to JSON
        run: |
          mkdir -p data

          ID=1
          echo "[" > data/quotes.json
          first=1

          for file in assets/*.txt; do
            while IFS= read -r line; do
              [ -z "$line" ] && continue

              IFS='|' read -r _ from quote <<< "$line"

              newid=$(printf "%06d" $ID)

              from_escaped=$(echo "$from" | sed 's/"/\\"/g')
              quote_escaped=$(echo "$quote" | sed 's/"/\\"/g')

              [ $first -eq 0 ] && echo "," >> data/quotes.json

              echo "  {\"id\": \"$newid\", \"from\": \"$from_escaped\", \"quote\": \"$quote_escaped\"}" >> data/quotes.json

              ID=$((ID + 1))
              first=0
            done < "$file"
          done

          echo "]" >> data/quotes.json

          jq -c . data/quotes.json > data/quotes.min.json

      - name: Count total quotes
        id: count_lines
        run: |
          COUNT=$(jq length data/quotes.json)
          echo "total_quotes=$COUNT" >> $GITHUB_OUTPUT

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push if changed
        run: |
          if [[ `git status --porcelain` ]]; then
            git add data/quotes.json data/quotes.min.json
            git commit -m "Auto: Update - TOTAL QUOTES: ${{ steps.count_lines.outputs.total_quotes }}"
            git push
          else
            echo "No changes to commit"
          fi
